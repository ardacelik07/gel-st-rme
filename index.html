<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sevgililer G√ºn√º Rotamƒ±z üíï</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@500;600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Google Maps JavaScript API - JSONP i√ßin gerekli deƒüil ama harita g√∂sterimi i√ßin kullanƒ±labilir -->
    <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAKS4a9rCu2hRTebc2lHA9o24BthtqyLjc&libraries=places,directions&language=tr"></script> -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: #0f0610;
            background-image:
                radial-gradient(ellipse 80% 50% at 50% -20%, rgba(255, 107, 157, 0.15), transparent),
                radial-gradient(ellipse 60% 40% at 100% 100%, rgba(196, 69, 105, 0.12), transparent),
                radial-gradient(ellipse 50% 30% at 0% 80%, rgba(255, 143, 171, 0.1), transparent),
                linear-gradient(165deg, #0f0610 0%, #1a0a12 25%, #2d1525 50%, #1a0a12 100%);
            min-height: 100vh;
            padding: 24px;
            color: #fff;
            overflow-x: hidden;
        }

        .container {
            max-width: 560px;
            width: 100%;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeIn 1s ease-out;
        }

        .header .heart-badge {
            font-size: 2.5rem;
            margin-bottom: 12px;
            animation: pulse 2s ease-in-out infinite;
        }

        .header h1 {
            font-family: 'Caveat', cursive;
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffb3c6, #ff8fab);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            text-shadow: 0 0 40px rgba(255, 182, 193, 0.3);
        }

        .header .date {
            color: #e8b4bc;
            font-size: 1rem;
            opacity: 0.95;
        }

        .intro {
            text-align: center;
            margin-bottom: 38px;
            padding: 24px 26px;
            background: linear-gradient(145deg, rgba(255, 182, 193, 0.08), rgba(196, 69, 105, 0.06));
            border-radius: 24px;
            border: 1px solid rgba(255, 182, 193, 0.2);
            animation: fadeIn 1s ease-out 0.2s both;
            box-shadow: 0 4px 24px rgba(0,0,0,0.15);
        }

        .intro p {
            font-size: 1.06rem;
            line-height: 1.7;
            color: #f2d8dd;
            font-weight: 500;
        }


        .timeline {
            position: relative;
            padding-left: 48px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 19px;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, rgba(255, 107, 157, 0.4), rgba(196, 69, 105, 0.6));
            border-radius: 2px;
        }

        .stop {
            position: relative;
            margin-bottom: 28px;
            animation: slideIn 0.6s ease-out forwards;
            opacity: 0;
        }

        .stop:nth-child(1) { animation-delay: 0.25s; }
        .stop:nth-child(2) { animation-delay: 0.45s; }
        .stop:nth-child(3) { animation-delay: 0.65s; }
        .stop:nth-child(4) { animation-delay: 0.85s; }

        .stop-marker {
            position: absolute;
            left: -42px;
            top: 28px;
            width: 48px;
            height: 48px;
            background: linear-gradient(145deg, rgba(255, 107, 157, 0.2), rgba(196, 69, 105, 0.15));
            border: 3px solid #ff8fab;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #ff8fab;
            font-size: 1.2rem;
            box-shadow: 0 0 28px rgba(255, 143, 171, 0.4), inset 0 2px 4px rgba(255,255,255,0.1);
            z-index: 2;
        }

        .stop-card {
            background: linear-gradient(160deg, rgba(55, 30, 55, 0.85) 0%, rgba(28, 12, 28, 0.95) 100%);
            border-radius: 20px;
            padding: 28px 30px;
            border: 2px solid rgba(255, 182, 193, 0.2);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.4s ease, box-shadow 0.4s ease, border-color 0.3s ease;
            min-height: 130px;
            backdrop-filter: blur(8px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .stop-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(0.7);
        }

        .stop-card.completed {
            border-color: rgba(76, 175, 80, 0.6);
            background: linear-gradient(160deg, rgba(55, 30, 55, 0.95) 0%, rgba(28, 12, 28, 1) 100%);
        }

        .stop-card.completed::after {
            content: '‚úì';
            position: absolute;
            top: 12px;
            right: 16px;
            width: 32px;
            height: 32px;
            background: rgba(76, 175, 80, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .stop-card:hover:not(.locked) {
            transform: translateY(-6px) scale(1.01);
            box-shadow: 0 20px 50px rgba(255, 107, 157, 0.25), 0 0 0 2px rgba(255, 182, 193, 0.15);
            border-color: rgba(255, 182, 193, 0.4);
        }

        .stop-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b9d, #ff8fab, #c44569);
            opacity: 0.8;
        }

        .stop-time {
            color: #ff8fab;
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 12px;
            text-align: center;
        }

        .stop-emoji {
            font-size: 3.5rem;
            margin-bottom: 0;
            display: block;
            text-align: center;
        }

        .tap-hint {
            text-align: center;
            margin-top: 35px;
            color: #b89098;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .tap-hint span {
            display: inline-block;
            animation: bounce 2s ease-in-out infinite;
        }

        /* Map Modal */
        .map-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        .map-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .map-modal-content {
            width: 95%;
            max-width: 900px;
            height: 90vh;
            background: #1a0a0e;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            position: relative;
            animation: slideUp 0.4s ease-out;
            display: flex;
            flex-direction: column;
        }

        .map-modal-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, #ff6b9d, #c44569);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            min-height: 100px;
        }

        .map-modal-title {
            font-family: 'Caveat', cursive;
            font-size: 1.8rem;
            color: #fff;
            font-weight: 600;
            text-align: center;
            flex: 1;
        }

        .map-modal-question {
            font-family: 'Nunito', sans-serif;
            font-size: 1.1rem;
            color: #fff;
            text-align: center;
            margin-top: 8px;
            opacity: 0.95;
        }

        .map-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: #fff;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .map-modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .map-container {
            width: 100%;
            flex: 1;
            min-height: 0;
            position: relative;
            background: linear-gradient(135deg, #1a0a0e 0%, #2d1525 100%);
            overflow: hidden;
        }

        .map-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .journey-visualization {
            width: 100%;
            max-width: 500px;
            height: 300px;
            position: relative;
            margin-bottom: 20px;
        }

        .journey-path {
            position: absolute;
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, rgba(255, 107, 157, 0.3), rgba(196, 69, 105, 0.3));
            border-radius: 4px;
            top: 50%;
            transform: translateY(-50%);
            overflow: hidden;
        }

        .journey-path-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b9d, #ff8fab, #c44569);
            border-radius: 4px;
            width: 0%;
            transition: width 1s ease-out;
            box-shadow: 0 0 20px rgba(255, 107, 157, 0.5);
            position: relative;
        }

        .journey-path-fill::after {
            content: '';
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: #ff6b9d;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 107, 157, 0.8);
            animation: pulse 2s ease-in-out infinite;
        }

        .start-point, .end-point {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transform: translateY(-50%);
            top: 50%;
        }

        .start-point {
            left: 0;
            background: linear-gradient(135deg, #4caf50, #45a049);
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.6);
        }

        .end-point {
            right: 0;
            background: linear-gradient(135deg, #ff6b9d, #c44569);
            box-shadow: 0 0 20px rgba(255, 107, 157, 0.6);
            animation: destinationPulse 2s ease-in-out infinite;
        }

        .journey-hearts {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        .journey-heart {
            position: absolute;
            font-size: 1.2rem;
            opacity: 0;
            animation: heartFloat 3s ease-in-out infinite;
        }

        .journey-stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 12px 20px;
            background: rgba(255, 182, 193, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 182, 193, 0.2);
            min-width: 100px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ff8fab;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #d4a5b0;
        }

        @keyframes destinationPulse {
            0%, 100% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-50%) scale(1.1); }
        }

        @keyframes heartFloat {
            0% { opacity: 0; transform: translateY(0) scale(0.5); }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-100px) scale(1.2); }
        }

        .map-container:hover .map-container iframe {
            opacity: 0.9;
        }

        .map-modal-footer {
            padding: 16px 24px;
            background: rgba(255, 182, 193, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            border-top: 1px solid rgba(255, 182, 193, 0.2);
        }

        .distance-info {
            color: #f2d8dd;
            font-size: 0.95rem;
            font-weight: 600;
            text-align: center;
            padding: 8px 16px;
            background: rgba(255, 182, 193, 0.15);
            border-radius: 20px;
            min-width: 200px;
        }

        .distance-info.near {
            color: #4caf50;
            background: rgba(76, 175, 80, 0.2);
            animation: pulse 2s ease-in-out infinite;
        }

        .btn-complete {
            padding: 12px 28px;
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: #fff;
            border: none;
            border-radius: 50px;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-complete:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 28px rgba(76, 175, 80, 0.5);
        }

        .btn-complete:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .heart-float {
            position: fixed;
            bottom: -60px;
            animation: floatUp 10s ease-in infinite;
            opacity: 0.5;
            pointer-events: none;
            font-size: 28px;
            z-index: 0;
        }

        @keyframes floatUp {
            0% { bottom: -60px; opacity: 0; transform: scale(0.8); }
            8% { opacity: 0.5; }
            85% { opacity: 0.4; }
            100% { bottom: 100vh; opacity: 0; transform: scale(1.1); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-40px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes revealIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            50% { transform: scale(1.1); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }

        @media (max-width: 600px) {
            .header h1 { font-size: 2.2rem; }
            .stop-time { font-size: 1.25rem; }
            .stop-emoji { font-size: 2.2rem; }
            .timeline { padding-left: 42px; }
            .stop-marker {
                left: -36px;
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            .stop-name { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="heart-badge">üíï</div>
            <h1>Sevgililer G√ºn√º Rotamƒ±z</h1>
            <p class="date">14 ≈ûubat 2026</p>
        </div>

        <div class="intro">
            <p>Mamutum hazƒ±r mƒ±sƒ±n? üíï</p>
        </div>

        <div class="timeline">
            <div class="stop" data-stop="1">
                <div class="stop-marker">1</div>
                <div class="stop-card" id="stopCard1" onclick="tryOpenStop(1)">
                    <div class="stop-time">‚è∞ 11:00</div>
                    <div class="stop-emoji">ü•û</div>
                </div>
            </div>

            <div class="stop" data-stop="2">
                <div class="stop-marker">2</div>
                <div class="stop-card locked" id="stopCard2" onclick="tryOpenStop(2)">
                    <div class="stop-time">‚è∞ 14:30</div>
                    <div class="stop-emoji">üåä</div>
                </div>
            </div>

            <div class="stop" data-stop="3">
                <div class="stop-marker">3</div>
                <div class="stop-card locked" id="stopCard3" onclick="tryOpenStop(3)">
                    <div class="stop-time">‚è∞ 18:00</div>
                    <div class="stop-emoji">üçΩÔ∏è</div>
                </div>
            </div>

        </div>

        <p class="tap-hint"><span>üëÜ</span> ƒ∞lk duraƒüa tƒ±kla ve ba≈ülayalƒ±m! Her duraƒüƒ± tamamladƒ±ƒüƒ±nda bir sonrakini a√ßabilirsin.</p>
    </div>

    <!-- Map Modal -->
    <div class="map-modal" id="mapModal">
        <div class="map-modal-content">
            <div class="map-modal-header">
                <div style="flex: 1;">
                    <div class="map-modal-title" id="mapTitle">Ne yapacaƒüƒ±z?</div>
                    <div class="map-modal-question" id="mapQuestion"></div>
                </div>
                <button class="map-modal-close" onclick="closeMapModal()">√ó</button>
            </div>
            <div class="map-container" id="mapContainer">
                <div class="map-overlay" id="mapOverlay">
                    <div class="journey-visualization">
                        <div class="journey-path">
                            <div class="journey-path-fill" id="journeyProgress"></div>
                        </div>
                        <div class="start-point">üìç</div>
                        <div class="end-point">üíï</div>
                        <div class="journey-hearts" id="journeyHearts"></div>
                    </div>
                    <div class="journey-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="statDistance">-</div>
                            <div class="stat-label">Mesafe</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statTime">-</div>
                            <div class="stat-label">Tahmini S√ºre</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statProgress">0%</div>
                            <div class="stat-label">ƒ∞lerleme</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="map-modal-footer">
                <div class="distance-info" id="distanceInfo">Konum alƒ±nƒ±yor... üìç</div>
                <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">
                    <button class="btn-complete" id="btnComplete" onclick="completeStop()" disabled>
                        <span>‚úì</span> Buraya Ula≈ütƒ±k!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const locations = [
            { 
                name: "Pa≈üa Kƒ±r Bah√ßesi Van Kahvaltƒ±sƒ±", 
                lat: 36.8597478, 
                lng: 30.5346585,
                question: "Sabahƒ±n ilk ƒ±≈üƒ±ƒüƒ±nda ne yapacaƒüƒ±z? ü•û",
                hint: "Doƒüanƒ±n kucaƒüƒ±nda, sƒ±cacƒ±k bir ba≈ülangƒ±√ß..."
            },
            { 
                name: "Reev Coffee Beach Park", 
                lat: 36.8791988, 
                lng: 30.6654256,
                question: "√ñƒüleden sonra nereye gidiyoruz? üåä",
                hint: "Mavi ve sonsuz... Ayaklarƒ±mƒ±z kumda..."
            },
            { 
                name: "Big Chefs - Konyaaltƒ±", 
                lat: 36.8698289, 
                lng: 30.6501837,
                question: "Ak≈üam nerede bulu≈üacaƒüƒ±z? üçΩÔ∏è",
                hint: "G√ºn batƒ±mƒ±na yakƒ±n, romantik bir ak≈üam..."
            }
        ];

        // localStorage'dan tamamlanan duraklarƒ± y√ºkle
        function loadProgress() {
            const saved = localStorage.getItem('valentineRouteProgress');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    return [];
                }
            }
            return [];
        }
        
        // Tamamlanan duraklarƒ± localStorage'a kaydet
        function saveProgress() {
            localStorage.setItem('valentineRouteProgress', JSON.stringify(completedStops));
        }
        
        let completedStops = loadProgress();
        let currentStopIndex = null;
        let watchId = null;
        let userLocation = null;
        let currentDestination = null;
        const ARRIVAL_DISTANCE = 100; // 100 metre mesafe e≈üiƒüi
        
        // Sayfa y√ºklendiƒüinde tamamlanan duraklarƒ± g√∂rsel olarak i≈üaretle
        window.addEventListener('DOMContentLoaded', () => {
            completedStops.forEach(stopIndex => {
                const card = document.getElementById(`stopCard${stopIndex}`);
                if (card) {
                    card.classList.remove('locked');
                    card.classList.add('completed');
                }
                // Bir sonraki duraƒüƒ± a√ß
                const nextCard = document.getElementById(`stopCard${stopIndex + 1}`);
                if (nextCard) {
                    nextCard.classList.remove('locked');
                }
            });
        });

        function tryOpenStop(index) {
            const card = document.getElementById(`stopCard${index}`);
            
            // Eƒüer kilitliyse veya tamamlanmƒ±≈üsa a√ßma
            if (card.classList.contains('locked') || card.classList.contains('completed')) {
                if (card.classList.contains('locked')) {
                    // √ñnceki duraƒüƒ± tamamlamasƒ± gerektiƒüini g√∂ster
                    alert('√ñnce √∂nceki duraƒüƒ± tamamlaman gerekiyor! üíï');
                }
                return;
            }
            
            openMapModal(index);
        }

        function openMapModal(index) {
            const loc = locations[index - 1];
            const modal = document.getElementById('mapModal');
            const mapContainer = document.getElementById('mapContainer');
            const mapTitle = document.getElementById('mapTitle');
            const mapQuestion = document.getElementById('mapQuestion');
            const btnComplete = document.getElementById('btnComplete');
            const distanceInfo = document.getElementById('distanceInfo');
            
            currentStopIndex = index;
            
            // Soru g√∂ster, yer ismi gizle
            mapTitle.textContent = loc.question;
            mapQuestion.textContent = ''; // ƒ∞pucu metnini kaldƒ±r
            
            // √ñnceki konum takibini durdur
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            // Butonu ba≈ülangƒ±√ßta devre dƒ±≈üƒ± bƒ±rak
            btnComplete.disabled = true;
            distanceInfo.textContent = "Konum alƒ±nƒ±yor... üìç";
            distanceInfo.classList.remove('near');
            
            // Test i√ßin ilk konuma yakƒ±n bir konum (sadece ilk durak i√ßin)
            const testLocation = index === 1 ? {
                lat: 36.8600,  // ƒ∞lk konuma ~50m yakƒ±n
                lng: 30.5350
            } : null;
            
            // Kullanƒ±cƒ±nƒ±n konumunu al ve haritayƒ± a√ß
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Debug: Ger√ßek konumunuzu ve mesafeyi g√∂ster
                        const realDistance = calculateDistance(
                            userLocation.lat,
                            userLocation.lng,
                            loc.lat,
                            loc.lng
                        );
                        console.log('üìç Ger√ßek konumunuz:', userLocation);
                        console.log('üéØ Hedef konumu:', { lat: loc.lat, lng: loc.lng, name: loc.name });
                        console.log('üìè Haversine ile hesaplanan mesafe:', (realDistance / 1000).toFixed(2) + 'km');
                        console.log('üó∫Ô∏è Google Maps kontrol linki:', `https://www.google.com/maps/dir/${userLocation.lat},${userLocation.lng}/${loc.lat},${loc.lng}`);
                        
                        loadMapWithDirections(loc, userLocation);
                        startLocationTracking(loc);
                    },
                    (error) => {
                        console.error('Konum alƒ±namadƒ±:', error);
                        // Konum alƒ±namazsa sadece hedefi g√∂ster
                        loadMapWithDirections(loc, null);
                        
                        let errorMessage = "Konum izni gerekli üìç";
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage = "Konum izni reddedildi. L√ºtfen tarayƒ±cƒ± ayarlarƒ±ndan izin verin. üìç";
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMessage = "Konum bilgisi alƒ±namƒ±yor. GPS'i a√ßƒ±k olduƒüundan emin olun. üìç";
                        } else if (error.code === error.TIMEOUT) {
                            errorMessage = "Konum alƒ±mƒ± zaman a≈üƒ±mƒ±na uƒüradƒ±. GPS'i a√ßƒ±k olduƒüundan ve internet baƒülantƒ±nƒ±zƒ±n iyi olduƒüundan emin olun. üìç";
                        } else {
                            // HTTP √ºzerinden √ßalƒ±≈üƒ±yorsa (localhost hari√ß) HTTPS gerekiyor
                            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                            if (!isLocalhost && window.location.protocol === 'http:') {
                                errorMessage = "HTTPS gerekiyor! Konum takibi i√ßin g√ºvenli baƒülantƒ± (https://) kullanƒ±n. üìç";
                            } else {
                                errorMessage = "Konum alƒ±namadƒ±. L√ºtfen tekrar deneyin. üìç";
                            }
                        }
                        distanceInfo.textContent = errorMessage;
                        btnComplete.disabled = false; // Manuel olarak tamamlayabilir
                    },
                    { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 }
                );
            } else {
                // Geolocation desteklenmiyorsa
                loadMapWithDirections(loc, null);
                distanceInfo.textContent = "Konum desteklenmiyor üìç";
                btnComplete.disabled = false; // Manuel olarak tamamlayabilir
            }
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function loadMapWithDirections(destination, origin) {
            const mapContainer = document.getElementById('mapContainer');
            const mapOverlay = document.getElementById('mapOverlay');
            
            // Yol tarifi i√ßin Google Maps uygulamasƒ±nda a√ßma linki
            const directionsLink = origin 
                ? `https://www.google.com/maps/dir/?api=1&origin=${origin.lat},${origin.lng}&destination=${destination.lat},${destination.lng}&travelmode=driving&hl=tr`
                : `https://www.google.com/maps?q=${destination.lat},${destination.lng}`;
            
            // Eski iframe'i temizle
            const existingIframe = mapContainer.querySelector('iframe');
            const existingWrapper = mapContainer.querySelector('.iframe-wrapper');
            if (existingIframe) existingIframe.remove();
            if (existingWrapper) existingWrapper.remove();
            
            // Google Maps iframe sorunu nedeniyle, harita yerine g√∂rsel bir g√∂sterim yapƒ±yoruz
            // Kullanƒ±cƒ± "Yol Tarifi Al" butonuna tƒ±klayarak Google Maps'te a√ßabilir
            const mapVisualization = document.createElement('div');
            mapVisualization.className = 'iframe-wrapper';
            mapVisualization.style.position = 'absolute';
            mapVisualization.style.top = '0';
            mapVisualization.style.left = '0';
            mapVisualization.style.width = '100%';
            mapVisualization.style.height = '100%';
            mapVisualization.style.zIndex = '1';
            mapVisualization.style.background = 'linear-gradient(135deg, #1a0a0e 0%, #2d1525 100%)';
            mapVisualization.style.display = 'flex';
            mapVisualization.style.flexDirection = 'column';
            mapVisualization.style.alignItems = 'center';
            mapVisualization.style.justifyContent = 'center';
            mapVisualization.style.padding = '20px';
            mapVisualization.style.textAlign = 'center';
            mapVisualization.style.color = '#fff';
            
            mapVisualization.innerHTML = `
                <div style="font-size:4rem;margin-bottom:20px;animation:pulse 2s ease-in-out infinite;">üó∫Ô∏è</div>
                <div style="font-size:1.3rem;margin-bottom:10px;font-weight:600;color:#ff8fab;">Konum Takibi Aktif</div>
                <div style="font-size:0.95rem;margin-bottom:20px;color:#d4a5b0;line-height:1.6;">
                    Konumunuz ger√ßek zamanlƒ± olarak takip ediliyor.<br>
                    Hedefe yakla≈ütƒ±k√ßa mesafe g√ºncellenecek.
                </div>
            `;
            
            mapContainer.insertBefore(mapVisualization, mapOverlay);
            
            // Eski butonlarƒ± temizle
            const existingBtn = mapOverlay.querySelector('.directions-btn');
            if (existingBtn) existingBtn.remove();
        }

        let initialDistance = null;
        let journeyHeartsInterval = null;
        let lastRouteUpdate = 0;
        const ROUTE_UPDATE_INTERVAL = 5000; // 5 saniyede bir ger√ßek yol mesafesini g√ºncelle (Google Maps gibi)

        // Google Maps Directions API REST endpoint kullanarak ger√ßek yol mesafesini al
        // Backend proxy √ºzerinden √ßaƒürƒ± yapƒ±yoruz (CORS sorunu yok)
        async function getRouteDistance(origin, destination) {
            const API_KEY = 'AIzaSyAKS4a9rCu2hRTebc2lHA9o24BthtqyLjc';
            const apiUrl = `https://maps.googleapis.com/maps/api/directions/json?origin=${origin.lat},${origin.lng}&destination=${destination.lat},${destination.lng}&key=${API_KEY}&language=tr&units=metric&mode=driving`;
            
            console.log('üîç Google Maps Directions API √ßaƒürƒ±sƒ± yapƒ±lƒ±yor...', {
                origin: `${origin.lat},${origin.lng}`,
                destination: `${destination.lat},${destination.lng}`
            });
            
            // Backend proxy endpoint'i (server.py'de tanƒ±mlƒ±)
            const proxyEndpoint = `/api/directions?origin=${origin.lat},${origin.lng}&destination=${destination.lat},${destination.lng}`;
            
            try {
                // Backend proxy √ºzerinden √ßaƒürƒ± yap (GET metodu)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 saniye timeout
                
                const response = await fetch(proxyEndpoint, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                console.log('üì¶ API Response Status:', data.status);
                
                if (data.status === 'OK' && data.routes && data.routes[0] && data.routes[0].legs && data.routes[0].legs[0]) {
                    const leg = data.routes[0].legs[0];
                    const distance = leg.distance.value;
                    const duration = leg.duration.value;
                    console.log('‚úÖ Google Maps yol mesafesi:', (distance / 1000).toFixed(2) + 'km', 'S√ºre:', Math.round(duration / 60) + 'dk');
                    return { distance, duration };
                } else if (data.status === 'REQUEST_DENIED') {
                    console.error('‚ùå API Key hatasƒ±:', data.status, data.error_message || '');
                    throw new Error('API Key yetkilendirme hatasƒ±: ' + (data.error_message || data.status));
                } else {
                    throw new Error('Route bulunamadƒ±: ' + (data.status || 'Bilinmeyen hata'));
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('API √ßaƒürƒ±sƒ± timeout (10 saniye)');
                }
                // Backend proxy yoksa, direkt API'yi dene (CORS hatasƒ± alabiliriz)
                console.warn('‚ö†Ô∏è Backend proxy ba≈üarƒ±sƒ±z, direkt API deneniyor...', error.message);
                throw error;
            }
        }
        
        // getRouteDistance wrapper - hata durumunda Haversine kullan
        async function getRouteDistanceSafe(origin, destination) {
            try {
                return await getRouteDistance(origin, destination);
            } catch (error) {
                console.error('‚ùå Google Maps API hatasƒ±, Haversine kullanƒ±lƒ±yor:', error);
                // API ba≈üarƒ±sƒ±z olursa Haversine kullan
                const distance = calculateDistance(origin.lat, origin.lng, destination.lat, destination.lng);
                const duration = (distance / 1000 / 50) * 3600;
                return { distance, duration };
            }
        }

        function startLocationTracking(destination) {
            currentDestination = destination; // Test modu i√ßin kaydet
            const distanceInfo = document.getElementById('distanceInfo');
            const btnComplete = document.getElementById('btnComplete');
            const journeyProgress = document.getElementById('journeyProgress');
            const statDistance = document.getElementById('statDistance');
            const statTime = document.getElementById('statTime');
            const statProgress = document.getElementById('statProgress');
            const journeyHearts = document.getElementById('journeyHearts');
            
            // initialDistance watchPosition callback'inde set edilecek
            initialDistance = null;
            lastRouteUpdate = 0;
            
            // Kalp animasyonlarƒ±nƒ± ba≈ülat
            if (journeyHearts) {
                journeyHeartsInterval = setInterval(() => {
                    createJourneyHeart(journeyHearts);
                }, 2000);
            }
            
            console.log('üöÄ Konum takibi ba≈ülatƒ±ldƒ±. Hedef:', destination.name);
            
            watchId = navigator.geolocation.watchPosition(
                async (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // Konsola log ekle (test i√ßin)
                    console.log('üìç Konum g√ºncellendi:', {
                        lat: userLocation.lat,
                        lng: userLocation.lng,
                        accuracy: position.coords.accuracy + 'm'
                    });
                    
                    // Ger√ßek yol mesafesini al (Google Maps gibi)
                    const now = Date.now();
                    let distance, duration;
                    
                    // HER ZAMAN Google Maps API'den ger√ßek yol mesafesini al (her konum g√ºncellemesinde)
                    // Sadece √ßok sƒ±k √ßaƒürƒ± yapmamak i√ßin throttling uygula
                    if (initialDistance === null || (now - lastRouteUpdate) > ROUTE_UPDATE_INTERVAL) {
                        try {
                            const routeResult = await getRouteDistanceSafe(userLocation, destination);
                            distance = routeResult.distance;
                            duration = routeResult.duration;
                            lastRouteUpdate = now;
                            
                            // ƒ∞lk mesafeyi kaydet
                            if (initialDistance === null) {
                                initialDistance = distance;
                                console.log('üéØ Ba≈ülangƒ±√ß yol mesafesi (Google Maps):', (initialDistance / 1000).toFixed(2) + 'km', 'S√ºre:', Math.round(duration / 60) + 'dk');
                            }
                        } catch (error) {
                            console.error('‚ö†Ô∏è API hatasƒ±, Haversine kullanƒ±lƒ±yor:', error);
                            // API hatasƒ± durumunda Haversine kullan
                            distance = calculateDistance(
                                userLocation.lat,
                                userLocation.lng,
                                destination.lat,
                                destination.lng
                            );
                            duration = (distance / 1000 / 50) * 3600;
                            
                            if (initialDistance === null) {
                                initialDistance = distance;
                                console.log('üéØ Ba≈ülangƒ±√ß mesafesi (Haversine - ku≈ü u√ßu≈üu):', (initialDistance / 1000).toFixed(2) + 'km');
                            }
                        }
                    } else {
                        // Son 5 saniye i√ßindeyse √∂nceki API sonucunu kullan, ama mesafeyi g√ºncelle
                        // Haversine ile yakla≈üƒ±k mesafe hesapla (API √ßaƒürƒ±sƒ± yapmadan)
                        const currentHaversineDistance = calculateDistance(
                            userLocation.lat,
                            userLocation.lng,
                            destination.lat,
                            destination.lng
                        );
                        // √ñnceki API mesafesine g√∂re orantƒ±lƒ± olarak g√ºncelle
                        if (initialDistance !== null) {
                            // ƒ∞lk API √ßaƒürƒ±sƒ±ndan sonra Haversine ile orantƒ±lƒ± g√ºncelleme
                            const initialHaversine = calculateDistance(
                                userLocation.lat, // Bu yanlƒ±≈ü, ilk konumu kullanmalƒ±yƒ±z
                                userLocation.lng,
                                destination.lat,
                                destination.lng
                            );
                            // Daha doƒüru: Haversine deƒüi≈üim oranƒ±nƒ± kullan
                            const ratio = currentHaversineDistance / (initialDistance * 0.8); // Yakla≈üƒ±k d√ºzeltme
                            distance = initialDistance * ratio;
                            duration = (distance / 1000 / 50) * 3600;
                        } else {
                            distance = currentHaversineDistance;
                            duration = (distance / 1000 / 50) * 3600;
                        }
                    }
                    
                    // ƒ∞lerleme y√ºzdesini hesapla
                    const progress = Math.max(0, Math.min(100, ((initialDistance - distance) / initialDistance) * 100));
                    
                    // Konsola ilerleme logu
                    console.log('üìä ƒ∞lerleme (Ger√ßek yol mesafesi):', {
                        mesafe: (distance / 1000).toFixed(2) + 'km',
                        ilerleme: progress.toFixed(1) + '%',
                        kalan: ((initialDistance - distance) / 1000).toFixed(2) + 'km'
                    });
                    
                    // G√∂rsel g√∂stergeleri g√ºncelle
                    if (journeyProgress) journeyProgress.style.width = progress + '%';
                    if (statProgress) statProgress.textContent = Math.round(progress) + '%';
                    
                    // Mesafeyi g√∂ster
                    if (distance < 1000) {
                        const distanceText = `${Math.round(distance)} metre kaldƒ± üìç`;
                        if (distanceInfo) distanceInfo.textContent = distanceText;
                        if (statDistance) statDistance.textContent = Math.round(distance) + 'm';
                    } else {
                        const distanceText = `${(distance / 1000).toFixed(1)} km kaldƒ± üìç`;
                        if (distanceInfo) distanceInfo.textContent = distanceText;
                        if (statDistance) statDistance.textContent = (distance / 1000).toFixed(1) + 'km';
                    }
                    
                    // Tahmini s√ºre hesapla (API'den gelen s√ºre veya hesaplanan)
                    const estimatedTimeMinutes = Math.round(duration / 60);
                    if (estimatedTimeMinutes < 1) {
                        if (statTime) statTime.textContent = '<1dk';
                    } else {
                        if (statTime) statTime.textContent = estimatedTimeMinutes + 'dk';
                    }
                    
                    // Hedefe yakƒ±nsa butonu aktif et
                    if (distance <= ARRIVAL_DISTANCE) {
                        console.log('üéâ Hedefe ula≈üƒ±ldƒ±! Mesafe:', (distance / 1000).toFixed(2) + 'km');
                        if (distanceInfo) {
                            distanceInfo.textContent = "üéâ Buraya ula≈ütƒ±n!";
                            distanceInfo.classList.add('near');
                        }
                        if (btnComplete) btnComplete.disabled = false;
                        if (journeyProgress) journeyProgress.style.width = '100%';
                        if (statProgress) statProgress.textContent = '100%';
                        
                        // Kalp animasyonlarƒ±nƒ± durdur
                        if (journeyHeartsInterval) {
                            clearInterval(journeyHeartsInterval);
                            journeyHeartsInterval = null;
                        }
                        
                        // Ba≈üarƒ± kalpleri olu≈ütur
                        if (journeyHearts) {
                            for (let i = 0; i < 10; i++) {
                                setTimeout(() => createJourneyHeart(journeyHearts, true), i * 100);
                            }
                        }
                    } else {
                        if (distanceInfo) distanceInfo.classList.remove('near');
                        if (btnComplete) btnComplete.disabled = true;
                    }
                },
                (error) => {
                    console.error('Konum takibi hatasƒ±:', error);
                    
                    let errorMessage = "Konum takibi hatasƒ± üìç";
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMessage = "Konum izni reddedildi. Tarayƒ±cƒ± ayarlarƒ±ndan izin verin. üìç";
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        errorMessage = "Konum bilgisi alƒ±namƒ±yor. GPS'i kontrol edin. üìç";
                    } else if (error.code === error.TIMEOUT) {
                        errorMessage = "Konum takibi zaman a≈üƒ±mƒ±. GPS'i a√ßƒ±k olduƒüundan ve internet baƒülantƒ±nƒ±zƒ±n iyi olduƒüundan emin olun. üìç";
                    } else {
                        // HTTP √ºzerinden √ßalƒ±≈üƒ±yorsa (localhost hari√ß) HTTPS gerekiyor
                        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                        if (!isLocalhost && window.location.protocol === 'http:') {
                            errorMessage = "‚ö†Ô∏è HTTPS gerekiyor! Konum takibi i√ßin https:// kullanƒ±n veya localhost kullanƒ±n. üìç";
                        } else {
                            errorMessage = "Konum takibi hatasƒ±. Tekrar deneyin. üìç";
                        }
                    }
                    
                    distanceInfo.textContent = errorMessage;
                    if (journeyHeartsInterval) {
                        clearInterval(journeyHeartsInterval);
                        journeyHeartsInterval = null;
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 30000,
                    maximumAge: 10000
                }
            );
        }

        function createJourneyHeart(container, isSuccess = false) {
            const heart = document.createElement('div');
            heart.className = 'journey-heart';
            heart.innerHTML = ['üíï', 'üíó', '‚ù§Ô∏è', 'üíñ'][Math.floor(Math.random() * 4)];
            heart.style.left = Math.random() * 100 + '%';
            heart.style.top = Math.random() * 100 + '%';
            heart.style.animationDelay = Math.random() * 2 + 's';
            heart.style.animationDuration = (isSuccess ? 2 : 3) + 's';
            container.appendChild(heart);
            
            setTimeout(() => {
                heart.remove();
            }, (isSuccess ? 2 : 3) * 1000);
        }

        // Haversine form√ºl√º ile mesafe hesaplama (metre cinsinden)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // D√ºnya yarƒ±√ßapƒ± (metre)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function completeStop() {
            if (!currentStopIndex) return;
            
            const card = document.getElementById(`stopCard${currentStopIndex}`);
            const nextCard = document.getElementById(`stopCard${currentStopIndex + 1}`);
            
            // Bu duraƒüƒ± tamamlandƒ± olarak i≈üaretle
            card.classList.remove('locked');
            card.classList.add('completed');
            if (!completedStops.includes(currentStopIndex)) {
                completedStops.push(currentStopIndex);
                saveProgress(); // localStorage'a kaydet
            }
            
            // Bir sonraki duraƒüƒ± a√ß
            if (nextCard) {
                nextCard.classList.remove('locked');
                // Kƒ±sa bir animasyon efekti
                setTimeout(() => {
                    nextCard.style.transform = 'scale(1.05)';
                    setTimeout(() => {
                        nextCard.style.transform = '';
                    }, 300);
                }, 200);
            }
            
            // Modal'ƒ± kapat
            closeMapModal();
            
            // Ba≈üarƒ± mesajƒ±
            showCompletionMessage(currentStopIndex);
        }

        function showCompletionMessage(index) {
            const messages = [
                "Harika! ƒ∞lk duraƒüƒ± tamamladƒ±k! üíï",
                "S√ºper! ƒ∞kinci duraƒüa ge√ßiyoruz! üåä",
                "üéâ T√ºm rotayƒ± tamamladƒ±k! Harika bir g√ºn ge√ßirdik! üíï"
            ];
            
            // Ge√ßici bir bildirim g√∂ster (basit alert yerine daha g√ºzel bir ≈üey yapƒ±labilir)
            const message = messages[index - 1] || "Harika!";
            alert(message);
        }

        function closeMapModal() {
            // Konum takibini durdur
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            // Kalp animasyonlarƒ±nƒ± durdur
            if (journeyHeartsInterval) {
                clearInterval(journeyHeartsInterval);
                journeyHeartsInterval = null;
            }
            
            // ƒ∞statistikleri sƒ±fƒ±rla
            initialDistance = null;
            const journeyProgress = document.getElementById('journeyProgress');
            const statDistance = document.getElementById('statDistance');
            const statTime = document.getElementById('statTime');
            const statProgress = document.getElementById('statProgress');
            
            if (journeyProgress) journeyProgress.style.width = '0%';
            if (statDistance) statDistance.textContent = '-';
            if (statTime) statTime.textContent = '-';
            if (statProgress) statProgress.textContent = '0%';
            
            const modal = document.getElementById('mapModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Modal dƒ±≈üƒ±na tƒ±klayƒ±nca kapat
        document.getElementById('mapModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMapModal();
            }
        });

        // ESC tu≈üu ile kapat
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMapModal();
            }
        });

        function createHeart() {
            const heart = document.createElement('div');
            heart.className = 'heart-float';
            heart.innerHTML = ['üíï', 'üíó', '‚ù§Ô∏è', 'üíñ'][Math.floor(Math.random() * 4)];
            heart.style.left = Math.random() * 100 + '%';
            heart.style.animationDelay = Math.random() * 6 + 's';
            heart.style.animationDuration = (8 + Math.random() * 4) + 's';
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 12000);
        }

        setInterval(createHeart, 3500);
        for (let i = 0; i < 4; i++) setTimeout(createHeart, i * 600);
    </script>
</body>
</html>
